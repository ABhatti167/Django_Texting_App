<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>{{ room }} - DjChat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .chat-message {
            border: 2px solid #dedede;
            background-color: #f1f1f1;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            overflow: hidden;
            width: 60%;
            clear: both;
        }

        .chat-message.darker {
            border-color: #ccc;
            background-color: #ddd;
        }

        .chat-message.left {
            float: left;
            text-align: left;
        }

        .chat-message.right {
            float: right;
            text-align: right;
            background-color: #d1e7dd;
            border-color: #badbcc;
        }

        .time-left {
            color: #999;
            font-size: 0.85rem;
            display: block;
            margin-top: 5px;
        }

        /* Clear floats after each message container */
        #display::after {
            content: "";
            display: block;
            clear: both;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container py-4" style="max-width: 800px;">
        <h2 class="text-center mb-4">{{ room }} - Chatting App</h2>

        <div id="display" class="mb-4"
            style="height: 500px; width: 100%; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
            <!-- Messages will be appended here -->
        </div>

        <form id="post-form" class="d-flex gap-2" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="username" id="username" value="{{ username }}" />
            <input type="hidden" name="room_id" id="room_id" value="{{ room_details.id }}" />
            <input type="text" name="message" id="message" class="form-control" placeholder="Type your message..."
                required />
            <button type="submit" class="btn btn-primary">Send</button>
        </form>

        <div class="mt-3">
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">Back to Home</a>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            function loadMessages() {
                $.ajax({
                    type: "GET",
                    url: "/getMessages/{{ room }}/",
                    success: function (response) {
                        $("#display").empty();
                        response.messages.forEach(function (msg) {
                            let isOwnMessage = msg.user === "{{ username }}";
                            let alignmentClass = isOwnMessage ? 'right' : 'left';
                            let bgClass = isOwnMessage ? '' : 'darker';
                            let messageHtml = `
                                <div class="chat-message ${bgClass} ${alignmentClass}">
                                    <b>${msg.user}</b>
                                    <p>${msg.value}</p>
                                    <span class="time-left">${new Date(msg.date).toLocaleString()}</span>
                                </div>`;
                            $("#display").append(messageHtml);
                        });
                    },
                    error: function () {
                        alert("An error occurred while fetching messages.");
                    },
                });
            }

            loadMessages();
            setInterval(loadMessages, 1000);

            $("#post-form").submit(function (e) {
                e.preventDefault();

                $.ajax({
                    type: "POST",
                    url: "/send/",
                    data: {
                        username: $("#username").val(),
                        room_id: $("#room_id").val(),
                        message: $("#message").val(),
                        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
                    },
                    success: function () {
                        $("#message").val("");
                        loadMessages();
                    },
                    error: function () {
                        alert("Failed to send message.");
                    },
                });
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>